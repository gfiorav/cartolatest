<div class='main-map'>
  <img id='bm'/>
  <div class='main-map-overlay'>
    <div class='metainfo'>
      <h1 id='title'></h1>
      <h2 id='author'></h1>
    </div>
  </div>
</div>
<div class='bottom-bar'>
  <% MapsController::MAX_MAPS.times do |index| %>
    <div class='small-map'>
      <img id='sm-<%= index %>'/>
    </div>
  <% end %>
</div>

<script type="text/javascript">
  MAX_MAPS = <%= MapsController::MAX_MAPS %>;

  var maps = <%= raw @maps.map(&:to_hash).to_json %>
  var currentlyShowing = 0;

  $(document).ready(function () {
    setUp();
    showNextMap();

    function setUp () {
      App.published = App.cable.subscriptions.create("PublishedChannel", {
        connected: function () {
          console.log('Cable connected!');
        },

        received: function (message) {
          if (maps.length > MAX_MAPS) {
            maps.pop();
          }

          maps.unshift(message['map']);

          showNextMap();
        }
      });
      setupBigMap();
      setupSmallMaps();
    }

    function showNextMap() {
      loadBigMap(maps[0]);
      loadSmallMaps(maps);
    }

    function loadBigMap(map) {
      var bMURL = URLForDimensions(map.url, BMWidth, BMHeight);

      document.getElementById('bm').setAttribute('src', bMURL)
      document.getElementById('title').innerHTML = map.title;
      document.getElementById('author').innerHTML = 'by ' + map.author;
    }

    function setupBigMap() {
      var bigMap = document.getElementById('bm');
      var container = $('.main-map');

      BMWidth = container.width();
      BMHeight = container.height();

      setObjectDimensions(bigMap, BMWidth, BMHeight);
    }

    function setupSmallMaps() {
      var container = $('.small-map');

      SMWidth = container.width();
      SMHeight = container.height();

      for (var c = 0; c < MAX_MAPS; c++) {
        setObjectDimensions(document.getElementById('sm-' + c), SMWidth, SMHeight);
      }
    }

    function loadSmallMaps(maps) {
      for (var c in maps) {
        loadSmallMap(maps[c], c);
      }
    }

    function loadSmallMap(map, index) {
      var sMURL = URLForDimensions(map.url, SMWidth, SMHeight);

      document.getElementById('sm-' + index).setAttribute('src', sMURL)
    }

    function setObjectDimensions(object, width, height) {
      object.setAttribute('width', width);
      object.setAttribute('height', height);
    }

    function URLForDimensions(url, width, height) {
      return url.replace('{X}', Math.floor(width)).replace('{Y}', Math.floor(height));
    }
  })
</script>